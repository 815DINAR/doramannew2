// script36.js v6.4 - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
document.addEventListener('DOMContentLoaded', async () => {
 
 // Debug —Å–∏—Å—Ç–µ–º–∞ - –ø–µ—Ä–µ—Ö–≤–∞—Ç –≤—Å–µ—Ö console –º–µ—Ç–æ–¥–æ–≤
class DebugLogger {
    constructor() {
        this.logs = [];
        this.maxLogs = 100;
        this.isVisible = false;
        this.setupConsoleInterception();
        this.setupDebugUI();
    }

    setupConsoleInterception() {
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            info: console.info
        };

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º console.log
        console.log = (...args) => {
            this.addLog('log', args);
            originalConsole.log.apply(console, args);
        };

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º console.error
        console.error = (...args) => {
            this.addLog('error', args);
            originalConsole.error.apply(console, args);
        };

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º console.warn
        console.warn = (...args) => {
            this.addLog('warn', args);
            originalConsole.warn.apply(console, args);
        };

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º console.info
        console.info = (...args) => {
            this.addLog('info', args);
            originalConsole.info.apply(console, args);
        };
    }

    addLog(type, args) {
        const timestamp = new Date().toLocaleTimeString();
        const message = args.map(arg => 
            typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
        ).join(' ');

        this.logs.push({
            type,
            message,
            timestamp
        });

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤
        if (this.logs.length > this.maxLogs) {
            this.logs.shift();
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º UI –µ—Å–ª–∏ –∫–æ–Ω—Å–æ–ª—å –æ—Ç–∫—Ä—ã—Ç–∞
        if (this.isVisible) {
            this.updateDebugUI();
        }
    }

    setupDebugUI() {
        const debugButton = document.getElementById('debugButton');
        const debugConsole = document.getElementById('debugConsole');
        const closeDebug = document.getElementById('closeDebug');
        const clearLogs = document.getElementById('clearLogs');

        if (debugButton) {
            debugButton.addEventListener('click', () => {
                this.toggleDebugConsole();
            });
        }

        if (closeDebug) {
            closeDebug.addEventListener('click', () => {
                this.hideDebugConsole();
            });
        }

        if (clearLogs) {
            clearLogs.addEventListener('click', () => {
                this.clearLogs();
            });
        }
    }

    toggleDebugConsole() {
        const debugConsole = document.getElementById('debugConsole');
        if (debugConsole) {
            if (this.isVisible) {
                this.hideDebugConsole();
            } else {
                this.showDebugConsole();
            }
        }
    }

    showDebugConsole() {
        const debugConsole = document.getElementById('debugConsole');
        if (debugConsole) {
            debugConsole.classList.add('show');
            this.isVisible = true;
            this.updateDebugUI();
        }
    }

    hideDebugConsole() {
        const debugConsole = document.getElementById('debugConsole');
        if (debugConsole) {
            debugConsole.classList.remove('show');
            this.isVisible = false;
        }
    }

    updateDebugUI() {
        const debugLogs = document.getElementById('debugLogs');
        if (debugLogs) {
            debugLogs.innerHTML = this.logs.map(log => `
                <div class="debug-log-entry ${log.type}">
                    <span class="debug-timestamp">${log.timestamp}</span>
                    <span class="debug-message">${log.message}</span>
                </div>
            `).join('');
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            debugLogs.scrollTop = debugLogs.scrollHeight;
        }
    }

    clearLogs() {
        this.logs = [];
        this.updateDebugUI();
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º debug —Å–∏—Å—Ç–µ–º—É
const debugLogger = new DebugLogger();
// –î–µ–ª–∞–µ–º debugLogger –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º
window.debugLogger = debugLogger;

  console.log('üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è DoramaShorts v6.4...');
  
  // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  const authSuccess = await window.telegramAuth.init();
  
  if (!authSuccess) {
    console.error('‚ùå –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω–æ');
    return;
  }
  
  console.log('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ');
  
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
  const userData = await window.telegramAuth.getUserData();
  if (userData) {
    console.log('üìä –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', userData);
  }
  
  // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
  const videoPlayer = document.getElementById('currentVideo');
  const videoTitle = document.getElementById('videoTitle');
  const videoSeries = document.getElementById('videoSeries');
  const videoSeasons = document.getElementById('videoSeasons');
  const videoStatus = document.getElementById('videoStatus');
  const videoCountry = document.getElementById('videoCountry');
  const videoGenre = document.getElementById('videoGenre');
  const likeButton = document.getElementById('likeButton');
  const dislikeButton = document.getElementById('dislikeButton');
  const favoriteButton = document.getElementById('favoriteButton');
  const descriptionButton = document.getElementById('descriptionButton');
  const descriptionModal = document.getElementById('descriptionModal');
  const modalClose = document.getElementById('modalClose');
  const modalTitle = document.getElementById('modalTitle');
  const modalDescription = document.getElementById('modalDescription');
  
  // –≠–ª–µ–º–µ–Ω—Ç—ã –≤–∫–ª–∞–¥–æ–∫
  const mainTab = document.getElementById('mainTab');
  const favoritesTab = document.getElementById('favoritesTab');
  const mainContent = document.getElementById('mainContent');
  const favoritesContent = document.getElementById('favoritesContent');
  const favoritesList = document.getElementById('favoritesList');
  const favoritesEmpty = document.getElementById('favoritesEmpty');

  let videos = [];
  let videoOrder = [];
  let currentOrderIndex = 0;
  let userFavorites = userData?.favorites || [];
  let userLikes = userData?.likes || [];
  let userDislikes = userData?.dislikes || [];
  let currentTab = 'main';

  console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
  console.log('üìä –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', {
    favorites: userFavorites.length,
    likes: userLikes.length,
    dislikes: userDislikes.length
  });
  
  // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
  function switchTab(tabName) {
    currentTab = tabName;
    
    if (tabName === 'main') {
      mainTab.classList.add('active');
      favoritesTab.classList.remove('active');
      mainContent.classList.add('active');
      favoritesContent.classList.remove('active');
      
      // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–µ–æ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é –ë–ï–ó –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ò
      if (videoPlayer) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ
        if (videoPlayer.src) {
          videoPlayer.play().catch(error => {
            console.error('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ:', error);
          });
        } else {
          // –ï—Å–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –Ω–µ—Ç, –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ
          loadVideo();
        }
      }
    } else if (tabName === 'favorites') {
      mainTab.classList.remove('active');
      favoritesTab.classList.add('active');
      mainContent.classList.remove('active');
      favoritesContent.classList.add('active');
      
      // –°—Ç–∞–≤–∏–º –≤–∏–¥–µ–æ –Ω–∞ –ø–∞—É–∑—É –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
      if (videoPlayer && !videoPlayer.paused) {
        videoPlayer.pause();
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
      updateFavoritesList();
    }
  }
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –ø–æ –≤–∫–ª–∞–¥–∫–∞–º - —É–ª—É—á—à–µ–Ω–Ω–∞—è –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å
  if (mainTab) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ª—É—á—à–µ–π –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏
    const handleMainTab = (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (currentTab !== 'main') {
        switchTab('main');
      }
    };
    
    mainTab.addEventListener('click', handleMainTab);
    mainTab.addEventListener('touchstart', (e) => {
      e.preventDefault();
      handleMainTab(e);
    }, { passive: false });
    
    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
    mainTab.addEventListener('touchstart', () => {
      mainTab.style.transform = 'scale(0.95)';
    });
    mainTab.addEventListener('touchend', () => {
      mainTab.style.transform = 'scale(1)';
    });
  }
  
  if (favoritesTab) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ª—É—á—à–µ–π –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏
    const handleFavoritesTab = (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (currentTab !== 'favorites') {
        switchTab('favorites');
      }
    };
    
    favoritesTab.addEventListener('click', handleFavoritesTab);
    favoritesTab.addEventListener('touchstart', (e) => {
      e.preventDefault();
      handleFavoritesTab(e);
    }, { passive: false });
    
    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
    favoritesTab.addEventListener('touchstart', () => {
      favoritesTab.style.transform = 'scale(0.95)';
    });
    favoritesTab.addEventListener('touchend', () => {
      favoritesTab.style.transform = 'scale(1)';
    });
  }
  
  // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
  async function updateFavoritesList() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    const freshUserData = await window.telegramAuth.getUserData();
    if (freshUserData) {
      userFavorites = freshUserData.favorites || [];
    }
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –≤–∏–¥–µ–æ, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º
    const favoriteVideos = videos.filter(video => 
      userFavorites.includes(video.filename)
    );
    
    if (favoriteVideos.length === 0) {
      favoritesEmpty.style.display = 'flex';
      favoritesList.style.display = 'none';
      favoritesList.classList.remove('has-items');
    } else {
      favoritesEmpty.style.display = 'none';
      favoritesList.style.display = 'flex';
      favoritesList.classList.add('has-items');
      
      // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
      favoritesList.innerHTML = '';
      
      favoriteVideos.forEach(video => {
        const card = createFavoriteCard(video);
        favoritesList.appendChild(card);
      });
    }
  }
  
  // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ
  function createFavoriteCard(video) {
    const card = document.createElement('div');
    card.className = 'favorite-card';
    card.setAttribute('data-video-filename', video.filename);
    
    // SVG –∑–∞–≥–ª—É—à–∫–∞ –≤–º–µ—Å—Ç–æ –≤–∏–¥–µ–æ –ø—Ä–µ–≤—å—é
    const thumbnail = document.createElement('div');
    thumbnail.className = 'favorite-card-thumbnail';
    
    // SVG –∏–∫–æ–Ω–∫–∞ –≤–∏–¥–µ–æ –≤–º–µ—Å—Ç–æ –ø—Ä–µ–≤—å—é
    thumbnail.innerHTML = `
      <svg width="100%" height="100%" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" rx="8" fill="#1a1a1a"/>
        <circle cx="40" cy="40" r="25" fill="#333"/>
        <path d="M35 30L50 40L35 50V30Z" fill="#666"/>
      </svg>
    `;
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∏–¥–µ–æ
    const info = document.createElement('div');
    info.className = 'favorite-card-info';
    
    const title = document.createElement('div');
    title.className = 'favorite-card-title';
    title.textContent = video.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    
    const genre = document.createElement('div');
    genre.className = 'favorite-card-genre';
    genre.textContent = video.genre || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    
    info.appendChild(title);
    info.appendChild(genre);
    
    // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    const removeBtn = document.createElement('button');
    removeBtn.className = 'favorite-card-remove';
    removeBtn.innerHTML = `
      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
      </svg>
    `;
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É - –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –†–ï–ê–ö–¶–ò–Ø
    const handleCardClick = (e) => {
      if (!e.target.closest('.favorite-card-remove')) {
        // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –≤–∏–¥–µ–æ
        const videoIndex = videos.findIndex(v => v.filename === video.filename);
        if (videoIndex !== -1) {
          // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
          switchTab('main');
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω—É–∂–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ë–ï–ó –ü–ï–†–ï–ó–ê–ì–†–£–ó–ö–ò
          const orderIndex = videoOrder.indexOf(videoIndex);
          if (orderIndex !== -1) {
            currentOrderIndex = orderIndex;
          } else {
            // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –≤ —Ç–µ–∫—É—â–µ–º –ø–æ—Ä—è–¥–∫–µ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
            currentOrderIndex = 0;
            videoOrder.unshift(videoIndex);
          }
          // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
          const currentVideoId = likeButton?.getAttribute('data-video-id');
          if (currentVideoId !== video.filename) {
            loadVideo();
          }
        }
      }
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–µ–∞–∫—Ü–∏–∏
    card.addEventListener('click', handleCardClick);
    card.addEventListener('touchstart', (e) => {
      e.stopPropagation();
      if (!e.target.closest('.favorite-card-remove')) {
        card.style.transform = 'scale(0.98)';
        card.style.opacity = '0.8';
      }
    }, { passive: true });
    
    card.addEventListener('touchend', (e) => {
      e.stopPropagation();
      card.style.transform = 'scale(1)';
      card.style.opacity = '1';
      handleCardClick(e);
    }, { passive: false });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    removeBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      
      // –£–¥–∞–ª—è–µ–º –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
      userFavorites = userFavorites.filter(id => id !== video.filename);
      updateButtonStates(video.filename);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      const success = await window.telegramAuth.toggleFavorite(video.filename);
      if (!success) {
        // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
        userFavorites.push(video.filename);
        updateButtonStates(video.filename);
      } else {
        // –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è
        card.style.transform = 'translateX(-100%)';
        card.style.opacity = '0';
        setTimeout(() => {
          updateFavoritesList();
        }, 300);
      }
    });
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–µ —É–¥–∞–ª–µ–Ω–∏—è
    removeBtn.addEventListener('touchstart', (e) => {
      e.stopPropagation();
    });
    
    // –°–æ–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
    card.appendChild(thumbnail);
    card.appendChild(info);
    card.appendChild(removeBtn);
    
    return card;
  }
  
  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–Ω–æ–ø–æ–∫ —Å pointer events - –£–ü–†–û–©–ï–ù–ù–ê–Ø
  function setupButtonWithPointerEvents(button, handler) {
    if (!button) return;
    
    // –ü—Ä–æ—Å—Ç–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
    const handleClick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
      button.style.transform = 'scale(0.95)';
      setTimeout(() => {
        button.style.transform = 'scale(1)';
      }, 100);
      
      // –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
      handler(e);
    };
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è
    button.addEventListener('click', handleClick);
    button.addEventListener('touchend', (e) => {
      e.preventDefault();
      handleClick(e);
    });
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
    button.addEventListener('selectstart', (e) => e.preventDefault());
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
    button.addEventListener('contextmenu', (e) => e.preventDefault());
  }
  
  // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è –º–∞—Å—Å–∏–≤–∞ –∏–Ω–¥–µ–∫—Å–æ–≤
  function shuffleVideos() {
    videoOrder = videos.map((_, index) => index);
    for (let i = videoOrder.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [videoOrder[i], videoOrder[j]] = [videoOrder[j], videoOrder[i]];
    }
    currentOrderIndex = 0;
    console.log('üîÄ –í–∏–¥–µ–æ –ø–µ—Ä–µ–º–µ—à–∞–Ω—ã, –ø–æ—Ä—è–¥–æ–∫:', videoOrder);
  }

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –≤–∏–¥–µ–æ —Å —Å–µ—Ä–≤–µ—Ä–∞
  async function fetchVideos() {
    console.log('üì• –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤–∏–¥–µ–æ...');
    try {
      const response = await fetch('get_videos.php');
      console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response);
      
      if (!response.ok) {
        throw new Error(`HTTP error: ${response.status}`);
      }
      
      const rawText = await response.text();
      console.log('üìÑ –°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–ø–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤):', rawText.substring(0, 500));
      
      try {
        videos = JSON.parse(rawText);
        console.log('‚úÖ JSON —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω');
        console.log('üì∫ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ:', videos.length);
        
        if (videos.length > 0) {
          shuffleVideos();
          loadVideo();
          updateFavoritesList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        } else {
          console.warn('‚ö†Ô∏è –ú–∞—Å—Å–∏–≤ –≤–∏–¥–µ–æ –ø—É—Å—Ç–æ–π');
        }
      } catch (parseError) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', parseError);
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:', error);
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
  function updateButtonStates(videoId) {
    console.log('üîÑ updateButtonStates –≤—ã–∑–≤–∞–Ω –¥–ª—è:', videoId);
    
    if (!videoId) {
      console.error('‚ùå videoId –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω!');
      return;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ª–∞–π–∫–∞
    if (likeButton) {
      const isLiked = userLikes.includes(videoId);
      likeButton.classList.toggle('active', isLiked);
      likeButton.setAttribute('data-video-id', videoId);
      
      const likeIcon = likeButton.querySelector('.like-icon');
      if (likeIcon) {
        likeIcon.src = isLiked ? 'svg/like-active.svg' : 'svg/like.svg';
      }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–∏–∑–ª–∞–π–∫–∞
    if (dislikeButton) {
      const isDisliked = userDislikes.includes(videoId);
      dislikeButton.classList.toggle('active', isDisliked);
      dislikeButton.setAttribute('data-video-id', videoId);
      
      const dislikeIcon = dislikeButton.querySelector('.dislike-icon');
      if (dislikeIcon) {
        dislikeIcon.src = isDisliked ? 'svg/dislike-active.svg' : 'svg/dislike.svg';
      }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    if (favoriteButton) {
      const isFavorite = userFavorites.includes(videoId);
      favoriteButton.classList.toggle('active', isFavorite);
      favoriteButton.setAttribute('data-video-id', videoId);
      
      const favoriteIcon = favoriteButton.querySelector('.favorite-icon');
      if (favoriteIcon) {
        // –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –ò–ö–û–ù–ö–ò –ò–ó–ë–†–ê–ù–ù–û–ì–û —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞
        const timestamp = Date.now();
        favoriteIcon.src = isFavorite ? `svg/favorites-active.svg?t=${timestamp}` : `svg/favorites.svg?t=${timestamp}`;
      }
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–µ–æ
  async function loadVideo() {
    if (videos.length === 0) {
      console.warn('‚ö†Ô∏è –ù–µ—Ç –≤–∏–¥–µ–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
      return;
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –≤–∏–¥–µ–æ
    try {
      const freshUserData = await window.telegramAuth.getUserData();
      if (freshUserData) {
        userFavorites = freshUserData.favorites || [];
        userLikes = freshUserData.likes || [];
        userDislikes = freshUserData.dislikes || [];
        console.log('üîÑ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã:', {
          favorites: userFavorites.length,
          likes: userLikes.length,
          dislikes: userDislikes.length
        });
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
    }
    
    const idx = videoOrder[currentOrderIndex];
    const videoData = videos[idx];
    console.log(`üé¨ –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ ${currentOrderIndex + 1}/${videoOrder.length}, –∏–Ω–¥–µ–∫—Å: ${idx}`);
    
    if (videoData) {
      const newSrc = `uploads/${encodeURIComponent(videoData.filename)}`;
      console.log('üìÅ –ü—É—Ç—å –∫ –≤–∏–¥–µ–æ:', newSrc);
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –≤–∏–¥–µ–æ (–∏—Å–ø–æ–ª—å–∑—É–µ–º filename)
      const videoId = videoData.filename;
      
      // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ë–ï–ó –ó–ê–î–ï–†–ñ–ö–ò
      updateButtonStates(videoId);

      // –ü–ª–∞–≤–Ω–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≤–∏–¥–µ–æ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –º–µ–Ω—è–µ—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫
      if (videoPlayer.src !== newSrc) {
        videoPlayer.style.opacity = 0;
        setTimeout(() => {
          videoPlayer.src = newSrc;
          videoPlayer.load();
          
          // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
          if (currentTab === 'main') {
            videoPlayer.play().then(() => {
              console.log('‚úÖ –í–∏–¥–µ–æ –∑–∞–ø—É—â–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ');
            }).catch(error => {
              console.error('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ:', error);
            });
          }
          
          videoPlayer.style.opacity = 1;
        }, 100);
      } else {
        // –ï—Å–ª–∏ –≤–∏–¥–µ–æ —Ç–æ –∂–µ —Å–∞–º–æ–µ, –ø—Ä–æ—Å—Ç–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º
        if (currentTab === 'main' && videoPlayer.paused) {
          videoPlayer.play();
        }
      }

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–∏–¥–µ–æ
      videoTitle.textContent = videoData.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      videoGenre.textContent = `${videoData.genre || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`;
    }
  }

  // –§—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–µ–æ
  function nextVideo() {
    console.log('‚è≠Ô∏è –°–ª–µ–¥—É—é—â–µ–µ –≤–∏–¥–µ–æ');
    currentOrderIndex++;
    if (currentOrderIndex >= videoOrder.length) {
      console.log('üîÑ –î–æ—Å—Ç–∏–≥–Ω—É—Ç –∫–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞, –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∑–∞–Ω–æ–≤–æ');
      shuffleVideos();
    }
    loadVideo();
  }

  function previousVideo() {
    console.log('‚èÆÔ∏è –ü—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–∏–¥–µ–æ');
    currentOrderIndex--;
    if (currentOrderIndex < 0) {
      currentOrderIndex = videoOrder.length - 1;
    }
    loadVideo();
  }

  // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º (–° –ü–û–õ–ï–ú "–ì–û–î –í–´–ü–£–°–ö–ê")
  function showDescription() {
    console.log('üìñ –§—É–Ω–∫—Ü–∏—è showDescription –≤—ã–∑–≤–∞–Ω–∞');
    
    if (videos.length === 0) {
      console.warn('‚ö†Ô∏è –ù–µ—Ç –≤–∏–¥–µ–æ –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ–ø–∏—Å–∞–Ω–∏—è');
      return;
    }
    
    const idx = videoOrder[currentOrderIndex];
    const videoData = videos[idx];
    
    if (videoData) {
      const title = videoData.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      const description = videoData.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
      const series = videoData.series || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      const seasons = videoData.seasons || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      const status = videoData.status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      const country = videoData.country || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      const genre = videoData.genre || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      const year = videoData.year || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      
      const fullDescription = `${description}

üìä –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
‚Ä¢ –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: ${year}
‚Ä¢ –°–µ—Ä–∏–∏: ${series}
‚Ä¢ –°–µ–∑–æ–Ω—ã: ${seasons}  
‚Ä¢ –°—Ç–∞—Ç—É—Å: ${status}
‚Ä¢ –°—Ç—Ä–∞–Ω–∞: ${country}
‚Ä¢ –ñ–∞–Ω—Ä: ${genre}`;
      
      if (modalTitle) {
        modalTitle.textContent = title;
      }
      
      if (modalDescription) {
        modalDescription.textContent = fullDescription;
      }
      
      if (descriptionModal) {
        descriptionModal.classList.add('show');
        console.log('‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∫–∞–∑–∞–Ω–æ');
      }
    }
  }

  // –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  function hideDescription() {
    console.log('‚ùå –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–ø–∏—Å–∞–Ω–∏—è');
    if (descriptionModal) {
      descriptionModal.classList.remove('show');
    }
  }

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ –ª–∞–π–∫–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê
  setupButtonWithPointerEvents(likeButton, async (e) => {
    const videoId = likeButton.getAttribute('data-video-id');
    if (!videoId) {
      console.error('‚ùå Video ID –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!');
      return;
    }
    
    console.log('üëç –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∞–π–∫–∞ –¥–ª—è:', videoId);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
    try {
      const freshUserData = await window.telegramAuth.getUserData();
      if (freshUserData) {
        userFavorites = freshUserData.favorites || [];
        userLikes = freshUserData.likes || [];
        userDislikes = freshUserData.dislikes || [];
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
    }
    
    const isCurrentlyLiked = userLikes.includes(videoId);
    const wasDisliked = userDislikes.includes(videoId);
    
    // –ú–ì–ù–û–í–ï–ù–ù–û–ï –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    if (isCurrentlyLiked) {
      // –£–±–∏—Ä–∞–µ–º –ª–∞–π–∫
      userLikes = userLikes.filter(id => id !== videoId);
    } else {
      // –°—Ç–∞–≤–∏–º –ª–∞–π–∫
      userLikes.push(videoId);
      // –£–±–∏—Ä–∞–µ–º –¥–∏–∑–ª–∞–π–∫ –µ—Å–ª–∏ –±—ã–ª
      if (wasDisliked) {
        userDislikes = userDislikes.filter(id => id !== videoId);
      }
    }
    updateButtonStates(videoId);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –í–°–ï –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    const actions = [];
    
    if (isCurrentlyLiked) {
      // –ï—Å–ª–∏ —É–±–∏—Ä–∞–µ–º –ª–∞–π–∫
      actions.push(window.telegramAuth.updateReaction('remove_like', videoId));
    } else {
      // –ï—Å–ª–∏ —Å—Ç–∞–≤–∏–º –ª–∞–π–∫
      actions.push(window.telegramAuth.updateReaction('add_like', videoId));
      // –ò —É–±–∏—Ä–∞–µ–º –¥–∏–∑–ª–∞–π–∫ –µ—Å–ª–∏ –±—ã–ª
      if (wasDisliked) {
        actions.push(window.telegramAuth.updateReaction('remove_dislike', videoId));
      }
    }
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è
    Promise.all(actions).then(results => {
      const allSuccess = results.every(success => success === true);
      if (!allSuccess) {
        // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if (isCurrentlyLiked) {
          userLikes.push(videoId);
        } else {
          userLikes = userLikes.filter(id => id !== videoId);
          if (wasDisliked) {
            userDislikes.push(videoId);
          }
        }
        updateButtonStates(videoId);
        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
      }
    });
  });

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ –¥–∏–∑–ª–∞–π–∫–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê
  setupButtonWithPointerEvents(dislikeButton, async (e) => {
    const videoId = dislikeButton.getAttribute('data-video-id');
    if (!videoId) {
      console.error('‚ùå Video ID –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!');
      return;
    }
    
    console.log('üëé –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–∑–ª–∞–π–∫–∞ –¥–ª—è:', videoId);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
    try {
      const freshUserData = await window.telegramAuth.getUserData();
      if (freshUserData) {
        userFavorites = freshUserData.favorites || [];
        userLikes = freshUserData.likes || [];
        userDislikes = freshUserData.dislikes || [];
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
    }
    
    const isCurrentlyDisliked = userDislikes.includes(videoId);
    const wasLiked = userLikes.includes(videoId);
    
    // –ú–ì–ù–û–í–ï–ù–ù–û–ï –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    if (isCurrentlyDisliked) {
      // –£–±–∏—Ä–∞–µ–º –¥–∏–∑–ª–∞–π–∫
      userDislikes = userDislikes.filter(id => id !== videoId);
    } else {
      // –°—Ç–∞–≤–∏–º –¥–∏–∑–ª–∞–π–∫
      userDislikes.push(videoId);
      // –£–±–∏—Ä–∞–µ–º –ª–∞–π–∫ –µ—Å–ª–∏ –±—ã–ª
      if (wasLiked) {
        userLikes = userLikes.filter(id => id !== videoId);
      }
    }
    updateButtonStates(videoId);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –í–°–ï –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    const actions = [];
    
    if (isCurrentlyDisliked) {
      // –ï—Å–ª–∏ —É–±–∏—Ä–∞–µ–º –¥–∏–∑–ª–∞–π–∫
      actions.push(window.telegramAuth.updateReaction('remove_dislike', videoId));
    } else {
      // –ï—Å–ª–∏ —Å—Ç–∞–≤–∏–º –¥–∏–∑–ª–∞–π–∫
      actions.push(window.telegramAuth.updateReaction('add_dislike', videoId));
      // –ò —É–±–∏—Ä–∞–µ–º –ª–∞–π–∫ –µ—Å–ª–∏ –±—ã–ª
      if (wasLiked) {
        actions.push(window.telegramAuth.updateReaction('remove_like', videoId));
      }
    }
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è
    Promise.all(actions).then(results => {
      const allSuccess = results.every(success => success === true);
      if (!allSuccess) {
        // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if (isCurrentlyDisliked) {
          userDislikes.push(videoId);
        } else {
          userDislikes = userDislikes.filter(id => id !== videoId);
          if (wasLiked) {
            userLikes.push(videoId);
          }
        }
        updateButtonStates(videoId);
        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
      }
    });
  });

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ - –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –†–ï–ê–ö–¶–ò–Ø
  setupButtonWithPointerEvents(favoriteButton, async (e) => {
    const videoId = favoriteButton.getAttribute('data-video-id');
    if (!videoId) {
      console.error('‚ùå Video ID –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!');
      return;
    }
    
    console.log('‚≠ê –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–ª—è:', videoId);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
    try {
      const freshUserData = await window.telegramAuth.getUserData();
      if (freshUserData) {
        userFavorites = freshUserData.favorites || [];
        userLikes = freshUserData.likes || [];
        userDislikes = freshUserData.dislikes || [];
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
    }
    
    const isFavorite = userFavorites.includes(videoId);
    
    // –ú–ì–ù–û–í–ï–ù–ù–û–ï –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    if (isFavorite) {
      userFavorites = userFavorites.filter(id => id !== videoId);
    } else {
      userFavorites.push(videoId);
    }
    updateButtonStates(videoId);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ë–ï–ó –û–ñ–ò–î–ê–ù–ò–Ø
    window.telegramAuth.toggleFavorite(videoId).then(success => {
      if (!success) {
        // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if (isFavorite) {
          userFavorites.push(videoId);
        } else {
          userFavorites = userFavorites.filter(id => id !== videoId);
        }
        updateButtonStates(videoId);
        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
      }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –µ—Å–ª–∏ –º—ã –Ω–∞ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ
    if (currentTab === 'favorites') {
      setTimeout(() => updateFavoritesList(), 300);
    }
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ–ø–∏—Å–∞–Ω–∏—è
  if (descriptionButton) {
    // –ò–ö–û–ù–ö–ê –û–ü–ò–°–ê–ù–ò–Ø –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ svg/d.svg
    descriptionButton.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      console.log('üìñ –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è');
      showDescription();
    });
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è touch —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    descriptionButton.addEventListener('touchend', (e) => {
      e.preventDefault();
      e.stopPropagation();
      showDescription();
    });
  }

  if (modalClose) {
    modalClose.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      hideDescription();
    });
    
    modalClose.addEventListener('touchend', (e) => {
      e.preventDefault();
      e.stopPropagation();
      hideDescription();
    });
  }

  if (descriptionModal) {
    descriptionModal.addEventListener('click', (e) => {
      if (e.target === descriptionModal) {
        hideDescription();
      }
    });
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –≤–∏–¥–µ–æ –¥–ª—è –ø–∞—É–∑—ã/–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
  const videoContainer = document.querySelector('.video-container');
  if (videoContainer) {
    const handleVideoInteraction = (e) => {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      if (e.target.tagName.toLowerCase() === 'a' || 
          e.target.tagName.toLowerCase() === 'button' ||
          e.target.closest('button') || 
          e.target.closest('.action-buttons') ||
          e.target.closest('.description-modal') ||
          e.target.closest('.bottom-panel') ||
          e.target.closest('.favorites-container')) {
        return;
      }
      
      // –¢–æ–ª—å–∫–æ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
      if (currentTab === 'main' && videoPlayer) {
        if (videoPlayer.paused) {
          videoPlayer.play();
        } else {
          videoPlayer.pause();
        }
      }
    };
    
    videoContainer.addEventListener('click', handleVideoInteraction);
    
    // Touch –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
    let touchStartTime = 0;
    let touchStartTarget = null;
    
    videoContainer.addEventListener('touchstart', (e) => {
      touchStartTime = Date.now();
      touchStartTarget = e.target;
    });
    
    videoContainer.addEventListener('touchend', (e) => {
      const touchDuration = Date.now() - touchStartTime;
      if (touchDuration < 500 && touchStartTarget === e.target) {
        e.preventDefault();
        handleVideoInteraction(e);
      }
    });
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–≤–∞–π–ø–æ–≤ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–µ–æ (–ò–°–ü–†–ê–í–õ–ï–ù –ë–ê–ì –°–û –°–í–ê–ô–ü–û–ú –ù–ê–ó–ê–î)
  let touchStartY = 0;
  let touchStartX = 0;
  let touchEndY = 0;
  let touchEndX = 0;
  let isSwiping = false;
  
  if (videoPlayer) {
    videoPlayer.addEventListener('touchstart', (e) => {
      // –¢–æ–ª—å–∫–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
      if (currentTab !== 'main') return;
      
      touchStartY = e.changedTouches[0].screenY;
      touchStartX = e.changedTouches[0].screenX;
      isSwiping = false;
    }, { passive: true });
    
    videoPlayer.addEventListener('touchmove', (e) => {
      if (currentTab !== 'main') return;
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —á—Ç–æ —ç—Ç–æ —Å–≤–∞–π–ø, –∞ –Ω–µ —Å–ª—É—á–∞–π–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ
      const deltaY = Math.abs(e.changedTouches[0].screenY - touchStartY);
      const deltaX = Math.abs(e.changedTouches[0].screenX - touchStartX);
      
      if (deltaY > 10 || deltaX > 10) {
        isSwiping = true;
      }
      
      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ —Å–≤–∞–π–ø–µ –≤–Ω–∏–∑
      if (deltaY > deltaX && e.changedTouches[0].screenY > touchStartY) {
        e.preventDefault();
        e.stopPropagation();
      }
    }, { passive: false });
    
    videoPlayer.addEventListener('touchend', (e) => {
      if (!isSwiping || currentTab !== 'main') return;
      
      touchEndY = e.changedTouches[0].screenY;
      touchEndX = e.changedTouches[0].screenX;
      
      const deltaY = touchEndY - touchStartY;
      const deltaX = touchEndX - touchStartX;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–≤–∞–π–ø –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π, –∞ –Ω–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π
      if (Math.abs(deltaY) > Math.abs(deltaX)) {
        // –°–≤–∞–π–ø –≤–≤–µ—Ä—Ö - —Å–ª–µ–¥—É—é—â–µ–µ –≤–∏–¥–µ–æ
        if (deltaY < -50) {
          e.preventDefault();
          e.stopPropagation();
          nextVideo();
        }
        // –°–≤–∞–π–ø –≤–Ω–∏–∑ - –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–∏–¥–µ–æ (–ò–°–ü–†–ê–í–õ–ï–ù–û)
        else if (deltaY > 50) {
          e.preventDefault();
          e.stopPropagation();
          previousVideo();
        }
      }
    }, { passive: false });
    
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ Telegram –ø—Ä–∏ —Å–≤–∞–π–ø–µ
    videoPlayer.addEventListener('touchcancel', (e) => {
      isSwiping = false;
    });
  }
  
  // –¢–∞–∫–∂–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —Å–≤–∞–π–ø–µ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
  if (videoContainer) {
    videoContainer.addEventListener('touchmove', (e) => {
      const touch = e.changedTouches[0];
      const deltaY = touch.screenY - touchStartY;
      
      // –ï—Å–ª–∏ —Å–≤–∞–π–ø –≤–Ω–∏–∑ –∏ –º—ã –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ
      if (deltaY > 0 && window.scrollY === 0) {
        e.preventDefault();
        e.stopPropagation();
      }
    }, { passive: false });
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–ª–µ—Å–∞ –º—ã—à–∏
  let wheelTimeout = null;
  if (videoContainer) {
    videoContainer.addEventListener('wheel', (e) => {
      // –¢–æ–ª—å–∫–æ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
      if (currentTab !== 'main') return;
      
      e.preventDefault();
      if (wheelTimeout) return;
      if (e.deltaY > 0) {
        nextVideo();
      } else if (e.deltaY < 0) {
        previousVideo();
      }
      wheelTimeout = setTimeout(() => {
        wheelTimeout = null;
      }, 1000);
    });
  }

  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π video —ç–ª–µ–º–µ–Ω—Ç
  if (videoPlayer) {
    videoPlayer.muted = false;
  }

  // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  await fetchVideos();

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –≤–∏–¥–µ–æ
  if (videoPlayer && currentTab === 'main') {
    videoPlayer.play().catch(error => {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ –≤–∏–¥–µ–æ:', error);
    });
  }

  // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥)
  setInterval(async () => {
    try {
      const freshUserData = await window.telegramAuth.getUserData();
      if (freshUserData) {
        userFavorites = freshUserData.favorites || [];
        userLikes = freshUserData.likes || [];
        userDislikes = freshUserData.dislikes || [];
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∏–¥–µ–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
        const currentVideoId = likeButton?.getAttribute('data-video-id');
        if (currentVideoId) {
          updateButtonStates(currentVideoId);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –µ—Å–ª–∏ –º—ã –Ω–∞ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ
        if (currentTab === 'favorites') {
          updateFavoritesList();
        }
        
        console.log('üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞');
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
    }
  }, 10000); // 30 —Å–µ–∫—É–Ω–¥

  console.log('üéâ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ!');
  console.log('üì± –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è pointer events –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏');
  console.log('üîÑ –í–∫–ª—é—á–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö');
  console.log('‚≠ê –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ" —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å—é');
  console.log('üìÖ –í–µ—Ä—Å–∏—è 6.5 - –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
});